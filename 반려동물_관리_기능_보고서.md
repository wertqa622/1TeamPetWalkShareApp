# 반려동물 관리 기능 Firebase 설계 및 구현 보고서

## 목차
1. [개요](#개요)
2. [Firebase 데이터베이스 설계](#firebase-데이터베이스-설계)
3. [데이터 모델 설계](#데이터-모델-설계)
4. [주요 기능 구현](#주요-기능-구현)
5. [코드 구조](#코드-구조)
6. [기술 스택](#기술-스택)
7. [주요 특징](#주요-특징)

---

## 개요

본 프로젝트는 Flutter와 Firebase Firestore를 활용하여 반려동물 관리 기능을 구현한 모바일 애플리케이션입니다. 사용자는 반려동물 정보를 등록, 조회, 수정, 삭제할 수 있으며, 대표 반려동물을 설정하는 기능을 제공합니다.

### 주요 목표
- 반려동물 정보의 실시간 동기화
- 사용자별 반려동물 데이터 관리
- 대표 반려동물 설정 및 관리
- 직관적인 UI/UX 제공

---

## Firebase 데이터베이스 설계

### 1. 컬렉션 구조

```
Firestore
└── pets (컬렉션)
    ├── {documentId1} (문서)
    ├── {documentId2} (문서)
    └── ...
```

### 2. 문서 스키마

각 `pets` 컬렉션의 문서는 다음과 같은 구조를 가집니다:

| 필드명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| `id` | String | ✅ | 문서 ID (자동 생성) |
| `userId` | String | ✅ | 사용자 고유 ID |
| `name` | String | ✅ | 반려동물 이름 |
| `species` | String | ✅ | 종류 (예: 강아지, 고양이) |
| `breed` | String | ✅ | 품종 |
| `age` | Number | ✅ | 나이 |
| `createdAt` | String | ✅ | 생성 일시 (ISO 8601 형식) |
| `dateOfBirth` | String | ❌ | 생년월일 (ISO 8601 형식) |
| `gender` | String | ❌ | 성별 ('수컷' 또는 '암컷') |
| `weight` | Number | ❌ | 몸무게 (kg) |
| `isNeutered` | Boolean | ❌ | 중성화 여부 (기본값: false) |
| `isRepresentative` | Boolean | ❌ | 대표 반려동물 여부 (기본값: false) |

### 3. 인덱스 설계

**복합 인덱스:**
- `userId` + `isRepresentative` (대표 반려동물 조회 최적화)

**쿼리 패턴:**
```dart
// 사용자별 반려동물 조회
.where('userId', isEqualTo: userId)

// 대표 반려동물 확인
.where('userId', isEqualTo: userId)
.where('isRepresentative', isEqualTo: true)
```

### 4. 데이터 무결성 규칙

1. **대표 반려동물 제약조건**
   - 한 사용자당 최대 1개의 대표 반려동물만 존재 가능
   - 대표 반려동물 설정 시 기존 대표 반려동물은 자동으로 해제

2. **첫 반려동물 자동 설정**
   - 사용자가 첫 번째 반려동물을 등록할 때 자동으로 대표 반려동물로 설정

---

## 데이터 모델 설계

### Pet 클래스 구조

```dart
class Pet {
  final String id;
  final String userId;
  final String name;
  final String species;
  final String breed;
  final int age;
  final String createdAt;
  final DateTime? dateOfBirth;
  final String? gender;
  final double? weight;
  final bool isNeutered;
  final bool isRepresentative;
}
```

### 주요 메서드

1. **toFirestore()**: Firestore에 저장하기 위한 Map 변환
2. **fromFirestore()**: Firestore 문서를 Pet 객체로 변환
3. **toJson()**: JSON 직렬화
4. **fromJson()**: JSON 역직렬화

### Null Safety 처리

Firestore에서 필드가 없거나 null인 경우를 대비한 안전한 타입 변환:

```dart
isNeutered: json['isNeutered'] is bool ? json['isNeutered'] as bool : false,
isRepresentative: json['isRepresentative'] is bool 
    ? json['isRepresentative'] as bool 
    : false,
```

---

## 주요 기능 구현

### 1. 반려동물 추가 (Create)

**구현 위치:** `lib/services/firestore_service.dart`

```dart
static Future<String> addPet(Pet pet) async {
  // 해당 사용자의 기존 반려동물 개수 확인
  final existingPetsSnapshot = await _firestore
      .collection(_petsCollection)
      .where('userId', isEqualTo: pet.userId)
      .get();

  // 첫 번째 반려동물이면 대표 반려동물로 설정
  final isFirstPet = existingPetsSnapshot.docs.isEmpty;
  final petData = pet.toFirestore();
  if (isFirstPet) {
    petData['isRepresentative'] = true;
  }

  final docRef = await _firestore.collection(_petsCollection).add(petData);
  await docRef.update({'id': docRef.id});
  
  return docRef.id;
}
```

**특징:**
- 첫 반려동물 자동 대표 설정
- 문서 ID를 필드에 저장하여 참조 용이성 확보

### 2. 반려동물 조회 (Read)

**구현 위치:** `lib/services/firestore_service.dart`

```dart
static Stream<List<Pet>> getPetsByUserId(String userId) {
  return _firestore
      .collection(_petsCollection)
      .where('userId', isEqualTo: userId)
      .snapshots()
      .map((snapshot) {
    return snapshot.docs.map((doc) {
      final data = doc.data();
      data['id'] = doc.id;
      return Pet.fromFirestore(data);
    }).toList();
  });
}
```

**특징:**
- 실시간 업데이트를 위한 Stream 사용
- 사용자별 필터링 자동 적용

### 3. 반려동물 수정 (Update)

**구현 위치:** `lib/services/firestore_service.dart`

```dart
static Future<void> updatePet(String petId, Map<String, dynamic> data) async {
  final docRef = _firestore.collection(_petsCollection).doc(petId);
  await docRef.update(data);
}
```

**특징:**
- 부분 업데이트 지원
- 필요한 필드만 선택적으로 수정 가능

### 4. 반려동물 삭제 (Delete)

**구현 위치:** `lib/services/firestore_service.dart`

```dart
static Future<void> deletePet(String petId) async {
  await _firestore.collection(_petsCollection).doc(petId).delete();
}
```

**특징:**
- 간단한 문서 삭제
- 관련 데이터 정리 로직 확장 가능

### 5. 대표 반려동물 설정

**구현 위치:** `lib/services/firestore_service.dart`

```dart
static Future<void> setRepresentativePet(String userId, String petId) async {
  // 해당 사용자의 모든 반려동물의 isRepresentative를 false로 설정
  final petsSnapshot = await _firestore
      .collection(_petsCollection)
      .where('userId', isEqualTo: userId)
      .get();

  final batch = _firestore.batch();
  for (var doc in petsSnapshot.docs) {
    batch.update(doc.reference, {'isRepresentative': false});
  }

  // 선택한 반려동물의 isRepresentative를 true로 설정
  batch.update(
    _firestore.collection(_petsCollection).doc(petId),
    {'isRepresentative': true},
  );

  await batch.commit();
}
```

**특징:**
- Batch 작업을 통한 원자적 업데이트
- 데이터 일관성 보장
- 한 사용자당 하나의 대표 반려동물만 유지

---

## 코드 구조

### 디렉토리 구조

```
lib/
├── models/
│   └── pet.dart                    # Pet 데이터 모델
├── services/
│   └── firestore_service.dart      # Firestore 서비스 레이어
└── screens/
    ├── pet_management_screen.dart  # 반려동물 관리 화면
    └── add_pet_screen.dart         # 반려동물 추가/수정 화면
```

### 계층 구조

```
┌─────────────────────────────────┐
│   UI Layer (Screens)            │
│   - pet_management_screen.dart   │
│   - add_pet_screen.dart          │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Service Layer                  │
│   - firestore_service.dart       │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Model Layer                     │
│   - pet.dart                      │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Firebase Firestore              │
└──────────────────────────────────┘
```

### 주요 클래스 및 역할

#### 1. Pet (Model)
- **역할**: 반려동물 데이터를 표현하는 모델 클래스
- **책임**: 데이터 변환, 직렬화/역직렬화

#### 2. FirestoreService (Service)
- **역할**: Firestore와의 모든 상호작용을 담당
- **책임**: CRUD 작업, 대표 반려동물 관리, 실시간 스트림 제공

#### 3. PetManagementScreen (UI)
- **역할**: 반려동물 목록 표시 및 관리
- **책임**: UI 렌더링, 사용자 인터랙션 처리, 데이터 정렬

#### 4. AddPetScreen (UI)
- **역할**: 반려동물 추가/수정 폼
- **책임**: 입력 검증, 데이터 제출, 이미지 선택

---

## 기술 스택

### 프론트엔드
- **Flutter**: 크로스 플랫폼 모바일 프레임워크
- **Dart**: 프로그래밍 언어

### 백엔드/데이터베이스
- **Firebase Firestore**: NoSQL 실시간 데이터베이스
- **Cloud Firestore**: 문서 기반 데이터베이스

### 주요 패키지
```yaml
dependencies:
  cloud_firestore: ^5.4.3      # Firestore SDK
  firebase_core: ^3.6.0         # Firebase 코어
  image_picker: ^1.0.7          # 이미지 선택
  intl: ^0.20.2                 # 날짜 포맷팅
```

---

## 주요 특징

### 1. 실시간 동기화
- Firestore의 `snapshots()` 스트림을 활용하여 실시간 데이터 업데이트
- 여러 기기 간 자동 동기화
- 네트워크 상태 변화에 따른 자동 재연결

### 2. 데이터 정렬 및 필터링
- 대표 반려동물을 항상 최상단에 표시
- 클라이언트 측 정렬로 빠른 UI 반응

```dart
_pets = pets..sort((a, b) {
  if (a.isRepresentative && !b.isRepresentative) return -1;
  if (!a.isRepresentative && b.isRepresentative) return 1;
  return 0;
});
```

### 3. 안전한 타입 변환
- Null Safety를 고려한 안전한 데이터 파싱
- 기존 데이터와의 호환성 유지

### 4. 원자적 업데이트
- Batch 작업을 통한 다중 문서 업데이트
- 데이터 일관성 보장

### 5. 사용자 경험 최적화
- 첫 반려동물 자동 대표 설정
- 대표 반려동물은 버튼 숨김 처리
- 직관적인 UI/UX

---

## 데이터 흐름도

### 반려동물 추가 흐름

```
사용자 입력
    ↓
AddPetScreen (폼 검증)
    ↓
FirestoreService.addPet()
    ↓
기존 반려동물 확인
    ↓
첫 반려동물? → isRepresentative = true
    ↓
Firestore에 저장
    ↓
Stream 업데이트
    ↓
PetManagementScreen 자동 갱신
```

### 대표 반려동물 설정 흐름

```
사용자 버튼 클릭
    ↓
FirestoreService.setRepresentativePet()
    ↓
사용자의 모든 반려동물 조회
    ↓
Batch 작업 시작
    ↓
모든 반려동물 isRepresentative = false
    ↓
선택한 반려동물 isRepresentative = true
    ↓
Batch Commit
    ↓
Stream 업데이트
    ↓
UI 자동 갱신 및 정렬
```

---

## 보안 고려사항

### Firestore 보안 규칙 (권장)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /pets/{petId} {
      // 사용자는 자신의 반려동물만 읽을 수 있음
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // 사용자는 자신의 반려동물만 생성할 수 있음
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // 사용자는 자신의 반려동물만 수정할 수 있음
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // 사용자는 자신의 반려동물만 삭제할 수 있음
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
  }
}
```

---

## 성능 최적화

### 1. 인덱스 활용
- `userId` 필드에 인덱스 생성으로 쿼리 성능 향상

### 2. 스트림 관리
- `mounted` 체크를 통한 메모리 누수 방지
- 위젯 해제 시 자동 스트림 정리

### 3. 배치 작업
- 대표 반려동물 설정 시 여러 문서를 한 번에 업데이트하여 네트워크 요청 최소화

---

## 향후 개선 사항

1. **이미지 저장소**
   - Firebase Storage 연동으로 이미지 관리 개선

2. **오프라인 지원**
   - Firestore 오프라인 캐싱 활성화

3. **검색 기능**
   - 반려동물 이름/품종 검색 기능 추가

4. **통계 기능**
   - 반려동물별 통계 데이터 제공

5. **알림 기능**
   - 반려동물 관련 알림 설정

---

## 결론

본 프로젝트는 Firebase Firestore를 활용하여 반려동물 관리 기능을 효율적으로 구현하였습니다. 실시간 동기화, 안전한 데이터 처리, 직관적인 UI를 통해 사용자에게 편리한 반려동물 관리 경험을 제공합니다. 계층화된 아키텍처와 명확한 책임 분리를 통해 유지보수성과 확장성을 확보하였습니다.

---

**작성일**: 2024년  
**버전**: 1.0.0

