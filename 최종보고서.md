# 반려동물 산책 공유 앱 최종 보고서

## 목차
1. [프로젝트 개요](#1-프로젝트-개요)
2. [개발 환경 및 기술 스택](#2-개발-환경-및-기술-스택)
3. [사용 패키지 및 용도](#3-사용-패키지-및-용도)
4. [데이터베이스 설계](#4-데이터베이스-설계)
5. [아키텍처 설계](#5-아키텍처-설계)
6. [주요 기능별 상세 설명](#6-주요-기능별-상세-설명)
7. [기술적 특징 및 구현 방법](#7-기술적-특징-및-구현-방법)
8. [결론 및 향후 계획](#8-결론-및-향후-계획)

---

## 1. 프로젝트 개요

### 1.1 프로젝트 목적
본 프로젝트는 반려동물과 함께 산책하는 사용자들이 산책 기록을 공유하고, 주변에 산책 중인 다른 사용자들을 발견하여 소셜 네트워킹을 할 수 있는 모바일 애플리케이션을 개발하는 것을 목적으로 합니다.

### 1.2 주요 기능
- **반려동물 관리**: 반려동물 정보 등록 및 관리
- **산책 기록**: 실시간 위치 추적 및 산책 경로 기록
- **소셜 피드**: 팔로우한 사용자들의 산책 기록 확인
- **주변 사용자 탐색**: 1km 반경 내 산책 중인 사용자 실시간 표시
- **프로필 관리**: 사용자 프로필 수정, 팔로우/언팔로우, 차단 기능
- **산책 통계**: 산책 기록 통계 및 히스토리 조회

### 1.3 개발 기간 및 환경
- **개발 기간**: 학기 중 진행
- **개발 플랫폼**: Flutter (크로스 플랫폼)
- **타겟 플랫폼**: Android
- **백엔드**: Firebase (Firestore, Authentication, Storage)

---

## 2. 개발 환경 및 기술 스택

### 2.1 개발 환경
- **프레임워크**: Flutter 3.9.2
- **프로그래밍 언어**: Dart
- **IDE**: Android Studio / Visual Studio Code
- **버전 관리**: Git

### 2.2 기술 스택
- **프론트엔드**: Flutter (Material Design 3)
- **백엔드**: Firebase
  - Firestore (NoSQL 데이터베이스)
  - Firebase Authentication (사용자 인증)
  - Firebase Storage (이미지 저장)
- **위치 서비스**: Geolocator
- **지도**: Google Maps Flutter
- **백그라운드 서비스**: Flutter Background Service

---

## 3. 사용 패키지 및 용도

### 3.1 핵심 패키지

#### Firebase 관련
- **`firebase_core: ^3.6.0`**
  - Firebase 초기화 및 기본 설정
  - 모든 Firebase 서비스 사용을 위한 필수 패키지

- **`firebase_auth: ^5.7.0`**
  - 사용자 인증 관리
  - 이메일/비밀번호 로그인, Google 로그인 지원
  - 사용자 세션 관리

- **`cloud_firestore: ^5.4.3`**
  - NoSQL 데이터베이스
  - 실시간 데이터 동기화 (StreamBuilder 활용)
  - 사용자 정보, 산책 기록, 팔로우 관계 등 모든 데이터 저장

- **`firebase_storage: ^12.0.0`**
  - 이미지 파일 저장
  - 반려동물 프로필 이미지 업로드 및 관리

#### 위치 및 지도 관련
- **`geolocator: ^13.0.1`**
  - GPS 위치 정보 수집
  - 실시간 위치 추적
  - 두 지점 간 거리 계산 (Haversine 공식 사용)
  - 위치 권한 관리

- **`google_maps_flutter: ^2.10.0`**
  - Google Maps 지도 표시
  - 산책 경로 시각화
  - 주변 사용자 마커 표시
  - 실시간 위치 업데이트

#### 백그라운드 서비스 관련
- **`flutter_background_service: ^5.0.5`**
  - 백그라운드 위치 추적
  - 앱이 백그라운드에 있어도 위치 업데이트 지속
  - Foreground Service 구현 (Android 12+ 대응)

- **`flutter_background_service_android: ^6.3.1`**
  - Android 전용 백그라운드 서비스 설정
  - Foreground Service 알림 채널 관리

- **`flutter_local_notifications: ^17.2.4`**
  - 로컬 알림 표시
  - 주변 사용자 발견 시 알림
  - 산책 중 상태 알림

#### 권한 관리
- **`permission_handler: ^11.3.1`**
  - 위치 권한 요청 및 관리
  - 알림 권한 요청
  - 권한 상태 확인

#### 소셜 기능
- **`google_sign_in: ^6.2.1`**
  - Google 계정으로 로그인
  - OAuth 2.0 인증

- **`share_plus: ^10.0.0`**
  - 산책 기록 공유 기능
  - 외부 앱으로 공유 (카카오톡, 문자 등)

#### 로컬 저장소
- **`shared_preferences: ^2.2.2`**
  - 간단한 키-값 데이터 저장
  - 사용자 ID, 산책 상태 등 임시 데이터 저장

#### 기타
- **`image_picker: ^1.0.7`**
  - 갤러리/카메라에서 이미지 선택
  - 반려동물 프로필 이미지 업로드

- **`intl: ^0.20.2`**
  - 날짜/시간 포맷팅
  - 다국어 지원 (한국어)

- **`flutter_localizations`**
  - 한국어 로컬라이제이션
  - 달력 위젯 한국어 지원

- **`flutter_blue_plus: ^1.31.0`**
  - Bluetooth 기능 (향후 확장용)
  - 현재는 미사용 상태

### 3.2 개발 도구
- **`flutter_lints: ^5.0.0`**
  - 코드 품질 검사
  - 린터 규칙 적용

---

## 4. 데이터베이스 설계

### 4.1 Firestore 데이터베이스 구조

본 프로젝트는 Firebase Firestore를 NoSQL 데이터베이스로 사용합니다. 다음과 같은 컬렉션 구조로 설계되었습니다.

#### 4.1.1 `users` 컬렉션
사용자 기본 정보를 저장하는 메인 컬렉션입니다.

```
users/
  {userId}/
    - id: String (사용자 고유 ID)
    - email: String (이메일 주소)
    - nickname: String (닉네임)
    - bio: String (한줄 소개)
    - locationPublic: Boolean (위치 공개 여부)
    - followers: Number (팔로워 수)
    - following: Number (팔로잉 수)
    - createdAt: Timestamp (계정 생성 시간)
    - walkingStatus: String ('on' | 'off', 산책 중 여부)
    - latitude: Number (현재 위도, 산책 중일 때만 업데이트)
    - longitude: Number (현재 경도, 산책 중일 때만 업데이트)
    - lastUpdated: Timestamp (위치 마지막 업데이트 시간)
    
    // 서브컬렉션
    followers/          // 나를 팔로우하는 사용자 목록
      {followerId}/
        - followerId: String
        - nickname: String
        - bio: String
        - email: String
        - ...
        - followedAt: Timestamp
    
    following/          // 내가 팔로우하는 사용자 목록
      {followingNickname}/  // 문서 ID는 정규화된 닉네임
        - followingId: String
        - nickname: String
        - bio: String
        - ...
        - followedAt: Timestamp
    
    a_user/            // 내가 차단한 사용자 목록
      {blockedNickname}/
        - blockedId: String
        - nickname: String
        - ...
        - blockedAt: Timestamp
    
    d_user/            // 나를 차단한 사용자 목록
      {blockerNickname}/
        - blockerId: String
        - nickname: String
        - ...
        - blockedAt: Timestamp
```

**설계 특징:**
- `followers`와 `following`은 서브컬렉션으로 관리하여 실시간 업데이트가 용이합니다.
- `following` 컬렉션의 문서 ID는 정규화된 닉네임을 사용하여 가독성을 높였습니다.
- 차단 기능은 `a_user`(차단한 사용자)와 `d_user`(차단당한 사용자)로 양방향 관리합니다.

#### 4.1.2 `pets` 컬렉션
반려동물 정보를 저장하는 컬렉션입니다.

```
pets/
  {petId}/
    - id: String
    - userId: String (소유자 ID)
    - name: String (반려동물 이름)
    - species: String (종류: "강아지", "고양이" 등)
    - breed: String (품종)
    - age: Number (나이)
    - dateOfBirth: String (생년월일, ISO8601 형식)
    - gender: String ("수컷" | "암컷")
    - weight: Number (체중, kg)
    - isNeutered: Boolean (중성화 여부)
    - isRepresentative: Boolean (대표 반려동물 여부)
    - imageUrl: String (Firebase Storage URL)
    - createdAt: String (등록 시간)
```

**인덱싱:**
- `userId` 필드에 인덱스를 생성하여 사용자별 반려동물 조회 성능을 최적화했습니다.

#### 4.1.3 `walks` 컬렉션
산책 기록을 저장하는 컬렉션입니다.

```
walks/
  {walkId}/
    - id: String
    - userId: String (산책한 사용자 ID)
    - petId: String (함께 산책한 반려동물 ID)
    - startTime: Timestamp (산책 시작 시간)
    - endTime: Timestamp (산책 종료 시간)
    - distance: Number (총 거리, km)
    - duration: Number (총 시간, 초)
    - route: String (경로 데이터, JSON 형식)
    - notes: String (메모)
    - mood: String (기분: "기분 좋음", "보통", "피곤함" 등)
    - imageUrl: String (산책 사진 URL)
    - createdAt: Timestamp (기록 생성 시간)
    - walkingStatus: String ('on' | 'off')
    - likeCount: Number (좋아요 수)
    
    // 서브컬렉션
    likes/              // 좋아요한 사용자 목록
      {userId}/
        - userId: String
        - likedAt: Timestamp
```

**인덱싱:**
- `userId`와 `createdAt`에 복합 인덱스를 생성하여 사용자별 최신 산책 기록 조회를 최적화했습니다.

### 4.2 데이터 정규화 전략

#### 4.2.1 닉네임 정규화
Firestore 문서 ID에는 특수 문자(`/`, `?`, `#`, `[`, `]`, `*`)를 사용할 수 없습니다. 따라서 닉네임을 문서 ID로 사용할 때는 `NicknameNormalizer` 유틸리티를 통해 정규화합니다.

```dart
// 예시: "김/철수" → "김_철수"
final normalizedNickname = nickname
    .replaceAll('/', '_')
    .replaceAll('?', '_')
    .replaceAll('#', '_')
    .replaceAll('[', '_')
    .replaceAll(']', '_')
    .replaceAll('*', '_')
    .trim();
```

#### 4.2.2 Timestamp 처리
Firestore의 `Timestamp` 타입과 Dart의 `DateTime` 타입 간 변환을 `TimestampConverter` 유틸리티로 통일 관리합니다.

### 4.3 데이터 일관성 보장

#### 4.3.1 트랜잭션 및 배치 작업
- 팔로우/언팔로우 시 `Batch`를 사용하여 여러 문서를 원자적으로 업데이트합니다.
- 차단 시 양방향 팔로우 관계를 모두 제거하여 데이터 일관성을 보장합니다.

#### 4.3.2 실시간 동기화
- `StreamBuilder`를 활용하여 Firestore의 실시간 변경사항을 UI에 반영합니다.
- 팔로워/팔로잉 수는 서브컬렉션의 문서 개수를 실시간으로 계산합니다.

---

## 5. 아키텍처 설계

### 5.1 프로젝트 구조

```
lib/
├── main.dart                    # 앱 진입점, 라우팅 관리
├── firebase_options.dart        # Firebase 설정
│
├── models/                      # 데이터 모델
│   ├── user.dart               # 사용자 모델
│   ├── pet.dart                # 반려동물 모델
│   └── walk.dart               # 산책 기록 모델
│
├── screens/                     # UI 화면
│   ├── login_screen.dart        # 로그인 화면
│   ├── pet_management_screen.dart  # 반려동물 관리
│   ├── add_pet_screen.dart      # 반려동물 추가/수정
│   ├── walk_home_tap.dart      # 산책 홈 탭
│   ├── walk_tracking_screen.dart # 산책 추적 화면
│   ├── walk_tracking_tab.dart   # 산책 추적 탭
│   ├── walk_history_tap.dart   # 산책 히스토리
│   ├── walk_stats_tab.dart      # 산책 통계
│   ├── walk_detail_screen.dart  # 산책 상세 정보
│   ├── social_feed_screen.dart  # 소셜 피드
│   └── user_profile_screen.dart # 사용자 프로필
│
├── services/                    # 비즈니스 로직
│   ├── backgroundservice.dart   # 백그라운드 위치 추적
│   ├── firestore_service.dart   # 반려동물 CRUD
│   ├── firebase_storage_service.dart # 이미지 업로드
│   ├── follow_service.dart      # 팔로우/언팔로우
│   ├── block_service.dart       # 차단/차단 해제
│   ├── walk_service.dart        # 산책 기록 관리
│   ├── storage_service.dart     # 로컬 저장소
│   └── marker_isolate.dart     # 마커 생성 (Isolate)
│
└── utils/                       # 유틸리티
    ├── nickname_normalizer.dart # 닉네임 정규화
    ├── timestamp_converter.dart # Timestamp 변환
    └── user_converter.dart      # User 객체 변환
```

### 5.2 아키텍처 패턴

#### 5.2.1 레이어드 아키텍처 (Layered Architecture)
- **Presentation Layer**: `screens/` - UI 화면 및 위젯
- **Business Logic Layer**: `services/` - 비즈니스 로직 및 데이터 처리
- **Data Layer**: `models/` - 데이터 모델 및 변환
- **Utility Layer**: `utils/` - 공통 유틸리티 함수

#### 5.2.2 서비스 패턴
각 기능별로 서비스 클래스를 분리하여 재사용성과 유지보수성을 높였습니다.

- `FollowService`: 팔로우 관련 모든 로직
- `BlockService`: 차단 관련 모든 로직
- `WalkService`: 산책 기록 관련 로직
- `FirestoreService`: 반려동물 데이터 관리

### 5.3 상태 관리

#### 5.3.1 StatefulWidget 기반 상태 관리
- 각 화면은 `StatefulWidget`을 사용하여 로컬 상태를 관리합니다.
- Firestore의 실시간 업데이트는 `StreamBuilder`로 처리합니다.

#### 5.3.2 상태 전달
- 콜백 함수(`onUserUpdate`)를 통해 상위 위젯에 상태 변경을 알립니다.
- `SharedPreferences`를 사용하여 간단한 상태를 로컬에 저장합니다.

---

## 6. 주요 기능별 상세 설명

### 6.1 사용자 인증 및 프로필 관리

#### 6.1.1 로그인 기능
- **구현 위치**: `lib/screens/login_screen.dart`
- **사용 패키지**: `firebase_auth`, `google_sign_in`
- **기능 설명**:
  - 이메일/비밀번호 로그인
  - Google 계정 로그인 (OAuth 2.0)
  - 로그인 상태에 따라 자동 라우팅 (`AuthWrapper`)

#### 6.1.2 프로필 관리
- **구현 위치**: `lib/screens/user_profile_screen.dart`
- **주요 기능**:
  - 프로필 정보 수정 (닉네임, 한줄소개)
  - 위치 공개/비공개 설정
  - 팔로워/팔로잉 목록 조회 (실시간 업데이트)
  - 사용자 검색 및 팔로우
  - 차단/차단 해제 기능

**데이터 흐름:**
```
사용자 입력 → UserProfileScreen → Firestore 업데이트 
→ StreamBuilder 감지 → UI 자동 갱신
```

### 6.2 반려동물 관리

#### 6.2.1 반려동물 등록 및 수정
- **구현 위치**: `lib/screens/add_pet_screen.dart`
- **사용 서비스**: `FirestoreService`, `FirebaseStorageService`
- **기능 설명**:
  - 반려동물 기본 정보 입력 (이름, 종류, 품종, 나이 등)
  - 프로필 이미지 업로드 (Firebase Storage)
  - 첫 번째 반려동물은 자동으로 대표 반려동물로 설정

#### 6.2.2 반려동물 목록 관리
- **구현 위치**: `lib/screens/pet_management_screen.dart`
- **데이터 소스**: `FirestoreService.getPetsByUserId()` (Stream)
- **기능 설명**:
  - 사용자별 반려동물 목록 실시간 조회
  - 대표 반려동물을 맨 위에 표시
  - 반려동물 수정/삭제

**데이터 구조:**
```dart
// Firestore 쿼리
FirestoreService.getPetsByUserId(userId)
  .where('userId', isEqualTo: userId)
  .snapshots()
```

### 6.3 산책 기록 및 추적

#### 6.3.1 실시간 위치 추적
- **구현 위치**: `lib/services/backgroundservice.dart`
- **사용 패키지**: `flutter_background_service`, `geolocator`
- **기능 설명**:
  - 백그라운드에서 10초마다 위치 업데이트
  - Foreground Service로 Android 12+ 대응
  - 실시간 거리 계산 및 경로 저장

**구현 세부사항:**
```dart
Timer.periodic(Duration(seconds: 10), (timer) async {
  // 1. 현재 위치 가져오기
  Position pos = await Geolocator.getCurrentPosition(
    locationSettings: LocationSettings(accuracy: LocationAccuracy.high)
  );
  
  // 2. 이전 위치와의 거리 계산
  if (pathList.isNotEmpty) {
    double dist = Geolocator.distanceBetween(
      pathList.last['lat']!, pathList.last['lng']!,
      pos.latitude, pos.longitude
    );
    if (dist > 2) totalDistance += (dist / 1000); // 2m 이상 이동 시만 누적
  }
  
  // 3. Firestore에 위치 업데이트
  await FirebaseFirestore.instance
    .collection('users')
    .doc(myUserId)
    .update({
      'latitude': pos.latitude,
      'longitude': pos.longitude,
      'walkingStatus': 'on',
      'lastUpdated': FieldValue.serverTimestamp(),
    });
});
```

#### 6.3.2 산책 시작/종료
- **구현 위치**: `lib/screens/walk_tracking_screen.dart`
- **기능 설명**:
  - 산책 시작 시 백그라운드 서비스 활성화
  - 실시간 거리, 시간, 경로 표시
  - Google Maps에 경로 시각화
  - 산책 종료 시 기록 저장

**데이터 흐름:**
```
사용자 "산책 시작" 클릭
  → FlutterBackgroundService.invoke('setWalkingStatus')
  → 백그라운드 서비스 활성화
  → 10초마다 위치 업데이트
  → UI에 실시간 데이터 전달 (on('updateData'))
  → Google Maps 경로 업데이트
```

#### 6.3.3 산책 기록 저장
- **구현 위치**: `lib/screens/walk_tracking_screen.dart`
- **저장 데이터**:
  - 시작/종료 시간
  - 총 거리 (km)
  - 총 시간 (초)
  - 경로 데이터 (JSON 형식의 좌표 배열)
  - 메모, 기분, 사진 (선택사항)

### 6.4 주변 사용자 탐색

#### 6.4.1 실시간 주변 사용자 표시
- **구현 위치**: `lib/screens/walk_tracking_screen.dart`
- **기능 설명**:
  - 1km 반경 내 산책 중인 사용자를 Google Maps에 마커로 표시
  - Firestore의 `snapshots()`를 사용하여 실시간 업데이트
  - 클라이언트 측에서 거리 계산 (Haversine 공식)

**구현 세부사항:**
```dart
// Firestore 실시간 리스너
_usersSubscription = FirebaseFirestore.instance
  .collection('users')
  .snapshots()
  .listen((snapshot) {
    Set<Marker> markers = {};
    for (var doc in snapshot.docs) {
      if (doc.id == widget.userId) continue; // 자신 제외
      
      final data = doc.data();
      if (data['latitude'] != null && _curLatLng != null) {
        // 거리 계산 (Haversine 공식)
        double dist = Geolocator.distanceBetween(
          _curLatLng!.latitude, _curLatLng!.longitude,
          data['latitude'], data['longitude']
        );
        
        // 1km 이내 사용자만 마커 표시
        if (dist <= 1000) {
          markers.add(Marker(
            markerId: MarkerId(doc.id),
            position: LatLng(data['latitude'], data['longitude']),
            icon: BitmapDescriptor.defaultMarkerWithHue(
              BitmapDescriptor.hueAzure
            )
          ));
        }
      }
    }
    setState(() {
      _nearbyMarkers = markers;
    });
  });
```

#### 6.4.2 주변 사용자 알림
- **구현 위치**: `lib/services/backgroundservice.dart`
- **기능 설명**:
  - 백그라운드 서비스에서 10초마다 주변 사용자 확인
  - 1km 이내 사용자 발견 시 알림 표시
  - 5분 쿨다운으로 중복 알림 방지

**알림 로직:**
```dart
Future<void> _checkProximityAndNotify(
  String myId, double myLat, double myLng,
  Map<String, DateTime> cooldowns
) async {
  // 1. 산책 중인 모든 사용자 조회
  final snapshot = await FirebaseFirestore.instance
    .collection('users')
    .where('walkingStatus', isEqualTo: 'on')
    .get();
  
  for (var doc in snapshot.docs) {
    if (doc.id == myId) continue;
    
    // 2. 거리 계산
    double distanceMeters = Geolocator.distanceBetween(
      myLat, myLng, otherLat, otherLng
    );
    
    // 3. 1km 이내이고 쿨다운이 지났으면 알림
    if (distanceMeters <= 1000) {
      if (canNotify) {
        await _showProximityNotification(
          doc.id.hashCode, nickname, distanceMeters.toInt()
        );
        cooldowns[doc.id] = DateTime.now();
      }
    }
  }
}
```

### 6.5 소셜 피드

#### 6.5.1 피드 조회
- **구현 위치**: `lib/screens/social_feed_screen.dart`
- **기능 설명**:
  - 팔로우한 사용자들의 산책 기록을 시간순으로 표시
  - 차단된 사용자의 기록은 자동으로 필터링
  - 좋아요 기능
  - 산책 기록 공유 기능

**데이터 필터링:**
```dart
// WalkService.filterBlockedUsersWalks()
// 1. 조회자의 d_user 컬렉션에서 차단당한 사용자 목록 가져오기
// 2. 해당 사용자들의 산책 기록 제외
// 3. 팔로우한 사용자들의 기록만 반환
```

#### 6.5.2 좋아요 기능
- **구현 위치**: `lib/services/walk_service.dart`
- **데이터 구조**: `walks/{walkId}/likes/{userId}`
- **기능 설명**:
  - 좋아요 토글 (추가/제거)
  - 좋아요 수 실시간 업데이트
  - 중복 좋아요 방지

### 6.6 팔로우/차단 기능

#### 6.6.1 팔로우 시스템
- **구현 위치**: `lib/services/follow_service.dart`
- **데이터 구조**:
  - `users/{userId}/followers/{followerId}`: 나를 팔로우하는 사용자
  - `users/{userId}/following/{followingNickname}`: 내가 팔로우하는 사용자
- **기능 설명**:
  - 양방향 팔로우 관계 관리
  - 팔로워/팔로잉 수 자동 업데이트
  - 차단된 사용자는 팔로우 불가

**팔로우 로직:**
```dart
static Future<void> followUser(String followerId, String followingId) async {
  final batch = _firestore.batch();
  
  // 1. 팔로우당한 사용자의 followers 컬렉션에 추가
  batch.set(followersRef, {
    'followerId': followerId,
    'nickname': followerUserData['nickname'],
    // ... 기타 정보
  });
  
  // 2. 팔로우한 사용자의 following 컬렉션에 추가
  batch.set(followingRef, {
    'followingId': followingId,
    'nickname': followingUserData['nickname'],
    // ... 기타 정보
  });
  
  // 3. 카운트 업데이트
  batch.update(followingUserRef, {
    'followers': FieldValue.increment(1),
  });
  batch.update(followerUserRef, {
    'following': FieldValue.increment(1),
  });
  
  await batch.commit();
}
```

#### 6.6.2 차단 시스템
- **구현 위치**: `lib/services/block_service.dart`
- **데이터 구조**:
  - `users/{userId}/a_user/{blockedNickname}`: 내가 차단한 사용자
  - `users/{userId}/d_user/{blockerNickname}`: 나를 차단한 사용자
- **기능 설명**:
  - 차단 시 양방향 팔로우 관계 자동 해제
  - 차단된 사용자의 기록은 피드에서 제외
  - 차단 해제 기능

**차단 로직:**
```dart
static Future<void> blockUser(String blockerId, String blockedId) async {
  // 1. 차단 관계 생성 (a_user, d_user)
  // 2. 양방향 팔로우 관계 모두 삭제
  //    - blockerId의 following에서 blockedId 제거
  //    - blockedId의 following에서 blockerId 제거
  //    - blockerId의 followers에서 blockedId 제거
  //    - blockedId의 followers에서 blockerId 제거
  // 3. 카운트 업데이트
}
```

### 6.7 산책 통계 및 히스토리

#### 6.7.1 산책 히스토리
- **구현 위치**: `lib/screens/walk_history_tap.dart`
- **기능 설명**:
  - 사용자의 모든 산책 기록을 날짜순으로 표시
  - 각 기록의 거리, 시간, 날짜 표시
  - 상세 정보 조회 가능

#### 6.7.2 산책 통계
- **구현 위치**: `lib/screens/walk_stats_tab.dart`
- **기능 설명**:
  - 총 산책 횟수
  - 총 거리
  - 총 시간
  - 평균 거리/시간

---

## 7. 기술적 특징 및 구현 방법

### 7.1 실시간 데이터 동기화

#### 7.1.1 StreamBuilder 활용
Firestore의 `snapshots()`를 사용하여 실시간 데이터 변경을 감지하고 UI를 자동 업데이트합니다.

**예시: 팔로워 수 실시간 업데이트**
```dart
StreamBuilder<QuerySnapshot>(
  stream: FirebaseFirestore.instance
    .collection('users')
    .doc(_currentUser.id)
    .collection('followers')
    .snapshots(),
  builder: (context, snapshot) {
    final followerCount = snapshot.hasData 
      ? snapshot.data!.docs.where((doc) => doc.id != '.init').length
      : _currentUser.followers;
    
    return _buildStatItem('팔로워', followerCount.toString(), _showFollowersModal);
  },
)
```

#### 7.1.2 배치 작업으로 데이터 일관성 보장
여러 문서를 동시에 업데이트할 때 `Batch`를 사용하여 원자성을 보장합니다.

### 7.2 백그라운드 위치 추적

#### 7.2.1 Foreground Service 구현
Android 12+에서 백그라운드 위치 추적을 위해 Foreground Service를 사용합니다.

**구현 세부사항:**
- `isForegroundMode: true`로 설정
- 지속적인 알림 표시 (사용자에게 서비스 실행 중임을 알림)
- `foregroundServiceNotificationId`로 알림 ID 관리

#### 7.2.2 위치 업데이트 최적화
- 10초 간격으로 위치 업데이트 (배터리와 정확도의 균형)
- 2m 이상 이동한 경우에만 거리 누적 (GPS 오차 보정)
- 고정밀도 위치 설정 (`LocationAccuracy.high`)

### 7.3 거리 계산 알고리즘

#### 7.3.1 Haversine 공식
두 지점 간의 거리를 계산하기 위해 Haversine 공식을 사용합니다. `geolocator` 패키지의 `distanceBetween()` 메서드가 내부적으로 이 공식을 사용합니다.

**공식:**
```
a = sin²(Δφ/2) + cos φ1 ⋅ cos φ2 ⋅ sin²(Δλ/2)
c = 2 ⋅ atan2( √a, √(1−a) )
d = R ⋅ c
```
여기서:
- φ는 위도, λ는 경도
- R은 지구 반지름 (약 6,371km)

### 7.4 코드 최적화 및 리팩토링

#### 7.4.1 유틸리티 클래스 분리
중복 코드를 제거하고 재사용성을 높이기 위해 유틸리티 클래스를 생성했습니다.

- **`NicknameNormalizer`**: 닉네임 정규화 (10곳 이상에서 사용)
- **`TimestampConverter`**: Timestamp 변환 (5곳 이상에서 사용)
- **`UserConverter`**: User 객체 생성 (4곳 이상에서 사용)

#### 7.4.2 서비스 패턴
비즈니스 로직을 서비스 클래스로 분리하여 관심사를 분리했습니다.

### 7.5 성능 최적화

#### 7.5.1 Firestore 인덱싱
자주 조회되는 쿼리에 대해 복합 인덱스를 생성했습니다.
- `walks` 컬렉션: `userId` + `createdAt` (내림차순)
- `pets` 컬렉션: `userId`

#### 7.5.2 클라이언트 측 필터링
주변 사용자 탐색 시 서버 측 쿼리 대신 클라이언트에서 거리 계산을 수행합니다. (향후 GeoHash 기반 서버 측 쿼리로 개선 가능)

#### 7.5.3 이미지 최적화
- Firebase Storage에 이미지 저장
- 필요 시 이미지 압축 및 리사이징 (향후 구현)

### 7.6 보안 및 권한 관리

#### 7.6.1 Firebase Security Rules
Firestore와 Storage에 대한 접근 제어 규칙을 설정했습니다.

**예시:**
```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

#### 7.6.2 권한 요청
- 위치 권한: 산책 추적에 필수
- 알림 권한: 주변 사용자 알림에 필요
- 저장소 권한: 이미지 업로드에 필요

### 7.7 오류 처리 및 예외 관리

#### 7.7.1 Try-Catch 블록
모든 비동기 작업에 `try-catch` 블록을 추가하여 예외를 처리합니다.

#### 7.7.2 사용자 피드백
- `ScaffoldMessenger`를 사용하여 성공/실패 메시지 표시
- 로딩 인디케이터로 작업 진행 상태 표시

---

## 8. 결론 및 향후 계획

### 8.1 프로젝트 성과

본 프로젝트를 통해 다음과 같은 성과를 달성했습니다:

1. **실시간 위치 추적 시스템 구축**
   - 백그라운드 서비스를 활용한 안정적인 위치 추적
   - Android 12+ 대응 Foreground Service 구현

2. **소셜 네트워킹 기능 구현**
   - 팔로우/언팔로우 시스템
   - 차단 기능 및 자동 팔로우 해제
   - 실시간 데이터 동기화

3. **사용자 경험 개선**
   - 직관적인 UI/UX 설계
   - 실시간 피드 업데이트
   - 주변 사용자 알림

4. **코드 품질 향상**
   - 유틸리티 클래스로 중복 코드 제거
   - 서비스 패턴으로 관심사 분리
   - 유지보수성 향상

### 8.2 기술적 도전과 해결

#### 8.2.1 백그라운드 위치 추적
**문제**: Android 12+에서 백그라운드 위치 추적 제한
**해결**: Foreground Service 구현 및 지속적인 알림 표시

#### 8.2.2 실시간 데이터 동기화
**문제**: 여러 사용자가 동시에 데이터를 수정할 때 일관성 문제
**해결**: Firestore의 `Batch` 작업 및 트랜잭션 활용

#### 8.2.3 거리 계산 성능
**문제**: 많은 사용자가 있을 때 클라이언트 측 필터링 성능 저하
**해결**: 현재는 클라이언트 측 필터링 사용 (향후 GeoHash 기반 서버 측 쿼리로 개선 예정)

### 8.3 향후 개선 계획

#### 8.3.1 성능 최적화
- **GeoHash 기반 쿼리**: 주변 사용자 탐색을 서버 측에서 수행하여 네트워크 트래픽 감소
- **이미지 캐싱**: 자주 사용되는 이미지를 로컬에 캐싱
- **페이지네이션**: 피드와 히스토리에 페이지네이션 적용

#### 8.3.2 기능 확장
- **채팅 기능**: 주변 사용자와 실시간 채팅
- **그룹 산책**: 여러 사용자가 함께 산책하는 기능
- **산책 경로 추천**: 인기 산책 경로 추천
- **반려동물 건강 기록**: 산책 외 추가 건강 정보 관리

#### 8.3.3 사용자 경험 개선
- **다크 모드**: 다크 테마 지원
- **알림 설정**: 알림 종류별 개별 설정
- **통계 시각화**: 차트를 활용한 산책 통계 시각화

#### 8.3.4 보안 강화
- **Firebase Security Rules 세분화**: 더 세밀한 접근 제어
- **데이터 암호화**: 민감한 정보 암호화 저장

### 8.4 학습한 내용

본 프로젝트를 통해 다음과 같은 기술과 개념을 학습하고 적용했습니다:

1. **Flutter 프레임워크**
   - 위젯 트리 구조
   - 상태 관리
   - 비동기 프로그래밍 (Future, Stream)

2. **Firebase 서비스**
   - Firestore NoSQL 데이터베이스
   - 실시간 데이터 동기화
   - Firebase Authentication
   - Firebase Storage

3. **모바일 개발**
   - 위치 서비스 활용
   - 백그라운드 서비스 구현
   - 권한 관리
   - 알림 시스템

4. **소프트웨어 설계**
   - 레이어드 아키텍처
   - 서비스 패턴
   - 코드 리팩토링
   - 유틸리티 클래스 설계

5. **문제 해결 능력**
   - 복잡한 비즈니스 로직 구현
   - 성능 최적화
   - 오류 처리 및 예외 관리

### 8.5 마무리

본 프로젝트는 학기 중 배운 내용을 종합하여 실제로 동작하는 모바일 애플리케이션을 개발하는 좋은 경험이었습니다. 특히 실시간 데이터 동기화, 백그라운드 서비스, 위치 기반 서비스 등 모바일 앱 개발의 핵심 기술들을 직접 구현해볼 수 있었습니다.

향후 더 많은 기능을 추가하고 성능을 개선하여 실제 서비스로 출시할 수 있도록 지속적으로 개발을 진행하겠습니다.

---

## 부록

### A. 주요 파일 목록

#### 모델 (Models)
- `lib/models/user.dart`: 사용자 데이터 모델
- `lib/models/pet.dart`: 반려동물 데이터 모델
- `lib/models/walk.dart`: 산책 기록 데이터 모델

#### 서비스 (Services)
- `lib/services/backgroundservice.dart`: 백그라운드 위치 추적
- `lib/services/follow_service.dart`: 팔로우 기능
- `lib/services/block_service.dart`: 차단 기능
- `lib/services/walk_service.dart`: 산책 기록 관리
- `lib/services/firestore_service.dart`: 반려동물 데이터 관리
- `lib/services/firebase_storage_service.dart`: 이미지 업로드
- `lib/services/storage_service.dart`: 로컬 저장소

#### 화면 (Screens)
- `lib/screens/login_screen.dart`: 로그인
- `lib/screens/pet_management_screen.dart`: 반려동물 관리
- `lib/screens/walk_tracking_screen.dart`: 산책 추적
- `lib/screens/social_feed_screen.dart`: 소셜 피드
- `lib/screens/user_profile_screen.dart`: 사용자 프로필

### B. 참고 자료

- [Flutter 공식 문서](https://docs.flutter.dev/)
- [Firebase 공식 문서](https://firebase.google.com/docs)
- [Geolocator 패키지](https://pub.dev/packages/geolocator)
- [Google Maps Flutter](https://pub.dev/packages/google_maps_flutter)

---

**작성일**: 2024년  
**작성자**: [학생 이름]  
**과목명**: [과목명]  
**교수명**: [교수님 성함]
